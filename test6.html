<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Viewer</title>
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v5.0.0.min.js"></script>
        <script src="js/pixastic.core.js"></script>
        <script src="js/brightness.js"></script>
        <script type="text/javascript">
        	
            var contW, contH, contPosX, contPosY, imgW, imgH, stage, layer, picture;
            var mouseX, mouseY; 
            var lastX = 0;
            var lastY = 0;
            var resize = false;            

            $(function () {
                img = new Image;
                img.src = 'img/1.3.51.0.7.1465996233.36248.17230.40441.29652.7180.31075.jpg';
                img.onload = function () {  
                    Pixastic.process(img, "brightness", {brightness:50,contrast:0.5});
                    handlerContainerResize();                   
                    
                    $(window).resize(function (event) {
                        resize = true;
                        handlerContainerResize();
                    });                           
                };                 
            });

            function handlerContainerResize () {
                var imgRatio = img.width / img.height;

                contW = $(window).width();
                contH = $(window).height();

                if (contW / contH > imgRatio) {
                    imgH = contH;
                    imgW = imgH * imgRatio;
                } else {
                    imgW = contW;
                    imgH = imgW / imgRatio;
                }                   

                if (resize) {              
                    dimRatioW = $('#myContainer').width() / imgW;
                    dimRatioH = $('#myContainer').height() / imgH;

                    $('#myContainer').width(imgW);
                    $('#myContainer').height(imgH);  
                    stage.setWidth(imgW);
                    stage.setHeight(imgH);
                    
                    picture.setWidth(imgW);
                    picture.setHeight(imgH);

                    picture.x(picture.x() / dimRatioW);
                    picture.y(picture.y() / dimRatioH);

                    layer.draw();
                } else {     
                    $('#myContainer').width(imgW);
                    $('#myContainer').height(imgH);               
                    handlerDrawScene();
                }                   

                contPosX = (contW / 2) - (imgW / 2); 
                contPosY = (contH / 2) - (imgH / 2);

                $('#myContainer').css('top', contPosY);
                $('#myContainer').css('left', contPosX);

                
            }

            function handlerDrawScene () {
               stage = zoom.stage = filter.stage = new Kinetic.Stage({
                    container: 'myContainer',
                    width: imgW,
                    height: imgH
                });

                layer = zoom.layer = filter.layer = new Kinetic.Layer();

                picture = zoom.picture = filter.picture = new Kinetic.Image({
                    image: img,
                    x: 0, y: 0,
                    width: stage.getWidth(),
                    height: stage.getHeight(),
                });                 
                
                $(window).bind('contextmenu', function (event) {
                    event.preventDefault();
                });

                picture.on('mousedown', function (event) {
                    switch (event.which) {
                        case 1:
                            this.setDraggable(false); 
                            this.on('mousemove', filter.brightnessContrastEffect);
                            break;
                        case 2:
                            this.setDraggable(true); 
                            break;
                        case 3:
                            this.setDraggable(false); 
                            mouseX = event.clientX - $('#myContainer').offset().left;
                            mouseY = event.clientY - $('#myContainer').offset().top;                      
                            this.on('mousemove', zoom.zoomEffect);
                            break;
                    }                       
                });
                picture.on('mouseup', function (event) {  
                    this.setDraggable(false);                      
                    this.off('mousemove');
                    lastX = 0;
                    lastY = 0;
                });    

                layer.add(picture);
                stage.add(layer);          
            }

            var zoom = {
                stage: null,
                picture: null,
                layer: null,
                scale: 1,
                ratio: 1.01,
                zoomEffect: function (event) {
                    event.preventDefault();
                    var mY = event.offsetY;
                    var delta = mY - lastY;
                    
                    var zoomRatio = (zoom.ratio - (delta < 0 ? 0 : 0.02));
                    var newScale = zoom.scale * zoomRatio;
                    
                    var originX = zoom.picture.x();
                    var originY = zoom.picture.y();

                    originX = mouseX - (mouseX - originX) * zoomRatio;
                    originY = mouseY - (mouseY - originY) * zoomRatio;

                    zoom.picture.x(originX);
                    zoom.picture.y(originY);
                    zoom.picture.scale({x: newScale, y: newScale});
                    zoom.layer.draw();

                    zoom.scale *= zoomRatio;
                    lastY = mY;
                }
            };

            var filter = {
                stage: null,
                layer: null,
                picture: null,
                ratioX: 0,
                ratioY: 0,
                brightnessContrastEffect: function (event) {
                    event.preventDefault();
                    var mX = event.offsetX;
                    var mY = event.offsetY;
                    var deltaX = mX - lastX;
                    var deltaY = mY - lastY;

                    var effectRatioX = (deltaX < 0 ? 0.1 : -0.1);                    
                    var effectRatioY = (deltaY < 0 ? 20 : -20);
                    filter.ratioX += effectRatioX;
                    filter.ratioY += effectRatioY;                    

                    if (filter.ratioX <= -1) {
                        filter.ratioX = -1;
                    } else if (filter.ratioY <= -150) {
                        filter.ratioY = -150;
                    } else if (filter.ratioY >= 150) {
                        filter.ratioY = 150;
                    }

                    console.log(filter.ratioY +' | '+ filter.ratioX);
                    filter.picture.setImage(Pixastic.process(img, 'brightness', {brightness: filter.ratioY, contrast: filter.ratioX}));
                    filter.layer.draw();                   

                    lastX = mX;
                    lastY = mY;
                }
            };
        	
        </script>        
    </head>
	<body>
		<div id="myContainer"></div>    
    </body>
</html>
