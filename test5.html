<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Viewer</title>
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
        <script type="text/javascript" src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v5.0.0.min.js"></script>
        <script type="text/javascript">
        	
            var contW, contH, contPosX, contPosY, imgW, imgH, stage, layer, picture;
            var mouseX, mouseY, lastX, lastY = 0, lastOriginX, lastOriginY, lastScale;
            var resize = false;

            var zoom = {
                stage: null,
                picture: null,
                scale: 1,
                ratio: 1.01,
                zoomEffect: function(event) {
                    event.preventDefault();
                    var evt = event.originalEvent;
                    var mY = evt.offsetY;
                    var delta = mY - lastY;
                    
                    var zoomRatio = (zoom.ratio - (delta < 0 ? 0 : 0.02));
                    var newScale = zoom.scale * zoomRatio;
        
                    var originX = zoom.picture.x();
                    var originY = zoom.picture.y();
                    /*console.log(zoom);*/
                    originX = mouseX - (mouseX - originX) * zoomRatio;
                    originY = mouseY - (mouseY - originY) * zoomRatio;

                    zoom.picture.x(originX);
                    zoom.picture.y(originY);
                    zoom.picture.scale({x: newScale, y: newScale});
                    zoom.stage.draw();

                    zoom.scale *= zoomRatio;
                    lastY = mY;
                    lastOriginX = zoom.picture.x();
                    lastOriginY = zoom.picture.y();
                    lastScale = newScale;
                }
            };

            $(function () {
                img = new Image;
                img.src = 'img/1.3.51.0.7.1465996233.36248.17230.40441.29652.7180.31075.jpg';
                img.onload = function () {  
                    handlerContainerResize();                    
                    
                    $(window).resize(function (event) {
                        resize = true;
                        handlerContainerResize();
                    });                           
                };                 
            });

            function handlerContainerResize () {
                var imgRatio = img.width / img.height;

                contW = $(window).width();
                contH = $(window).height();

                if (contW / contH > imgRatio) {
                    imgH = contH;
                    imgW = imgH * imgRatio;
                } else {
                    imgW = contW;
                    imgH = imgW / imgRatio;
                }   

                $('#myContainer').width(imgW);
                $('#myContainer').height(imgH);

                if (resize) {                    
                    stage.width(imgW);
                    stage.height(imgH);
                    picture.width(imgW);
                    picture.height(imgH);
                    /*picture.x(0);
                    picture.y(0);*/
                    /*stage.draw(); */                 
                    /*console.log(dimRatioW +' | '+ dimRatioH);*/
                } else {                    
                    handlerDrawScene();
                }                   

                contPosX = (contW / 2) - (imgW / 2); 
                contPosY = (contH / 2) - (imgH / 2);

                $('#myContainer').css('top', contPosY);
                $('#myContainer').css('left', contPosX);

                
            }

            function handlerDrawScene () {
               stage = zoom.stage = new Kinetic.Stage({
                    container: 'myContainer',
                    width: imgW,
                    height: imgH
                });

                layer = new Kinetic.Layer();

                picture = zoom.picture = new Kinetic.Image({
                    image: img,
                    x: 0, y: 0,
                    width: stage.getWidth(),
                    height: stage.getHeight(),
                });                 

                layer.on("mousedown", function (event) { 
                    if (event.which === 2) {
                        layer.setDraggable(true);                       
                    }   
                    if (event.which === 1) {
                        picture.brightness(1);
                        layer.batchDraw();
                    }                      
                });

                
                $(window).bind('contextmenu', function (event) {
                    event.preventDefault();
                });

                $(stage.content).on('mousedown', function (event) {
                    if (event.which === 3) {
                        mouseX = event.clientX - $('#myContainer').offset().left;
                        mouseY = event.clientY - $('#myContainer').offset().top;
                        $(this).on('mousemove', zoom.zoomEffect);
                    }                        
                });
                $(stage.content).on('mouseup', function (event) {  
                    layer.setDraggable(false);                      
                    $(this).unbind('mousemove');
                });    

                layer.add(picture);
                stage.add(layer);          
            }
        	
        </script>        
    </head>
	<body>
		<div id="myContainer"></div>    
    </body>
</html>

