var handler={canvas:null,context:null,img:{},tempCanvas:null,tempContext:null,resize:false,resized:false,canvasSize:{w:0,h:0},canvasPos:{x:0,y:0},imgSize:{w:0,h:0},imgLastSize:{w:0,h:0},imgStartPos:{x:0,y:0},scale:1,ratio:1.001,zoomRatio:1,infoScale:0,respScale:0,lastX:0,lastY:0,origin:{x:0,y:0},lastOrigin:{x:0,y:0},ctxRatioW:0,ctxRatioH:0,mClickPos:{x:0,y:0},fTime:0,ba:1,b:1,c:1,isNegative:false,sources:{},records:0,pixelSpacing:0,set:0,charged:false,intervalLoad:null,countImages:0,numImages:0,numImg:1,tool:1,runAnimation:false,rClicks:0,rm:0,infoData:{bx:0,by:0,fx:0,fy:0,sx:0,sy:0,tx:0,ty:0,radius:1,cRuler:0,cAngle:0,cArea:0},regInfo:null,regCount:0,cRuler:0,cAngle:0,cArea:0,bx:0,by:0,fx:0,fy:0,sx:0,sy:0,tx:0,ty:0,rScroll:0,rScrollL:0,rScrollP:0,aRadius:0,asx:0,asy:0,match:false,orientation:null,posStartTwoFingers:{x:0,y:0},posMoveTwoFingers:{x:0,y:0},posDiffTwoFingers:{x:0,y:0},posScaleTwoFingers:{x:0,y:0},lastDrag:{x:0,y:0},posMoveLast:{x:0,y:0},posOrigin:{x:0,y:0},posTranslate:{x:0,y:0},posMoveFix:{x:0,y:0},mscale:1,mlastScale:1,mb:1,mc:1,mn:0,morigin:"",mtranslate:"",posStartOneFinger:{x:0,y:0},posMoveOneFinger:{x:0,y:0},posStartThreeFingers:{x:0,y:0},posMoveThreeFingers:{x:0,y:0},deltaX:1,deltaY:1,deltaYSet:0,init:function(){var a=this;if(a.mobileEnvironment.isMobile()){if($(window).width()>=$(window).height()){a.orientation="landscape"}else{a.orientation="portrait"}}a.workspace();a.toolbox();a.infoScene();a.infoTooSmall();a.screenTooSmall();a.configCanvas();a.chargeSets();a.dontDiagnostic()},workspace:function(){var c=this;if(!c.mobileEnvironment.isMobile()){var a='<div class="row"><div class="col-xs-2 center-block"><div id="toolbox" class="text-center"><div id="containerTitle" style="width: 100%; background-color: #f69322; border-top: 5px solid rgb(68, 68, 68); border-bottom: 5px solid rgb(68, 68, 68); color: #fff"><span id="toolboxTitle">'+lang.toolboxTitle+'</span></div><button id="play" type="button" class="btn btn-default btn-size" title="'+lang.buttonPlayset+'"><span class="glyphicon glyphicon-play"></span></button><button id="negative" type="button" class="btn btn-default btn-size" title="'+lang.buttonNegative+'"><span class="glyphicon glyphicon-adjust"></span></button><button id="magGlass" type="button" class="btn btn-default btn-size" title="'+lang.buttonLens+'"><span class="icon-magnifier"></span></button><div id="separator" style="width: 100%; height: 20px; background-color: rgb(68, 68, 68); border-top: 5px solid rgb(68, 68, 68); border-bottom: 5px solid rgb(68, 68, 68);"></div><button id="ruler" type="button" class="btn btn-default btn-size" title="'+lang.buttonRuler+'"><span class="icon-ruler"></span></button><button id="angle" type="button" class="btn btn-default btn-size" title="'+lang.buttonAngle+'"><span class="icon-ruler2"></span></button><button id="area" type="button" class="btn btn-default btn-size" title="'+lang.buttonArea+'"><span class="icon-circle"></span></button><div id="separator" style="width: 100%; height: 20px; background-color: rgb(68, 68, 68); border-top: 5px solid rgb(68, 68, 68); border-bottom: 5px solid rgb(68, 68, 68);"></div><button id="reset" type="button" class="btn btn-default btn-size" title="'+lang.buttonReset+'"><span class="icon-rotate"></span></button><button id="info" type="button" class="btn btn-warning btn-size" title="'+lang.buttonInfo+'"><span class="glyphicon glyphicon-list-alt"></span></button><button id="report" type="button" class="btn btn-default btn-size" title="'+lang.buttonReport+'" data-toggle="modal" data-target="#reportModal"><span class="icon-clipboard"></span></button><div id="separator" style="width: 100%; height: 20px; background-color: rgb(68, 68, 68); border-top: 5px solid rgb(68, 68, 68); border-bottom: 5px solid rgb(68, 68, 68);"></div><button id="sets" class="btn btn-default btn-size" title="'+lang.buttonSets+'" data-toggle="modal" data-target="#setsModal"><span class="glyphicon glyphicon-picture"></span></button><div id="contSetlist" style="position: relative"><div id="setlist" style="height: 400px; overflow: auto;"></div><div id="waitSet" style="width: 100%; height: 100%; position: absolute; left: 0px; top: 0px; z-index: 30; background-color: rgba(68, 68, 68, 0.8); display: table"><div style="height: 50px; display: table-cell; vertical-align: middle"><img src="img/waiting.gif" /></div></div></div></div></div><div class="col-xs-9"><div id="infoMedical"><p id="infoPatientName"></p><p id="infoPatientId"></p><p id="infoPatientSex"></p><p id="infoSerieBodyPart"></p><p id="infoInstitutionName"></p></div><div id="scene" class="center-block"></div><div id="dontDiagnostic">'+lang.msgDontDiagnostic+'</div><div id="infoScene"><p id ="infoScale"></p><p id ="infoBC"></p><p id ="infoIMG"></p></div></div><div class="col-xs-1"><div id="progressbar"><div id="scroll"></div></div></div></div><div class="modal fade" id="setsModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"><div class="modal-dialog modal-sm modal-setlist"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title" id="myModalLabel">'+lang.titleSetsModal+'</h4></div><div class="modal-body"><div id="contSetlistModal" style="position: relative"><div id="setlistModal" style="width: 200px; height: 400px; overflow: auto"></div><div id="waitSetModal" style="width: 200px; height: 100%; position: absolute; left: 0px; top: 0px; z-index: 30; background-color: rgba(68, 68, 68, 0.8); display: table"><div style="width: 200px; height: 50px; display: table-cell; vertical-align: middle" class="text-center"><img src="img/waiting.gif" /></div></div></div></div></div></div></div><div class="modal fade" id="reportModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true"><div class="modal-dialog modal-lg modal-report"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title" id="myModalLabel1">'+lang.titleReportModal+'</h4></div><div class="modal-body"><div id="report-pdf"></div></div></div></div></div>'}else{var a='<div class="row"><div id="contToolbox" class="col-xs-1 center-block"><div id="toolbox" class="text-center"><div id="containerTitle" class="separator" style="width: 100%; height: 20px; background-color: #f69322; border-top: 5px solid rgb(68, 68, 68); border-bottom: 5px solid rgb(68, 68, 68); color: #fff; display: table;"><span id="toolboxTitle" style="display: table-cell; vertical-align: middle;">'+lang.toolboxTitle+'</span></div><button id="playMobile" type="button" class="btn btn-default btn-size" title="'+lang.buttonPlayset+'"><span class="glyphicon glyphicon-play"></span></button><button id="negativeMobile" type="button" class="btn btn-default btn-size" title="'+lang.buttonNegative+'"><span class="glyphicon glyphicon-adjust"></span></button><div class="separator" style="width: 100%; height: 20px; background-color: rgb(68, 68, 68); border-top: 5px solid rgb(68, 68, 68); border-bottom: 5px solid rgb(68, 68, 68);"></div><button id="rulerMobile" type="button" class="btn btn-default btn-size" title="'+lang.buttonRuler+'"><span class="icon-ruler"></span></button><button id="angleMobile" type="button" class="btn btn-default btn-size" title="'+lang.buttonAngle+'"><span class="icon-ruler2"></span></button><button id="areaMobile" type="button" class="btn btn-default btn-size" title="'+lang.buttonArea+'"><span class="icon-circle"></span></button><div class="separator" style="width: 100%; height: 20px; background-color: rgb(68, 68, 68); border-top: 5px solid rgb(68, 68, 68); border-bottom: 5px solid rgb(68, 68, 68);"></div><button id="resetMobile" type="button" class="btn btn-default btn-size" title="'+lang.buttonReset+'"><span class="icon-rotate"></span></button><button id="infoMobile" type="button" class="btn btn-warning btn-size" title="'+lang.buttonInfo+'"><span class="glyphicon glyphicon-list-alt"></span></button><button id="reportMobile" type="button" class="btn btn-default btn-size" title="'+lang.buttonReport+'" data-toggle="modal" data-target="#reportModalMobile"><span class="icon-clipboard"></span></button><div class="separator" style="width: 100%; height: 20px; background-color: rgb(68, 68, 68); border-top: 5px solid rgb(68, 68, 68); border-bottom: 5px solid rgb(68, 68, 68);"></div><button id="setsMobile" class="btn btn-default btn-size" title="'+lang.buttonSets+'" data-toggle="modal" data-target="#setsModalMobile"><span class="glyphicon glyphicon-picture"></span></button></div></div><div id="contScene" class="col-xs-10"><div id="infoMedical"><p id="infoPatientName"></p><p id="infoPatientId"></p><p id="infoPatientSex"></p><p id="infoSerieBodyPart"></p><p id="infoInstitutionName"></p></div><div id="scene" class="center-block"></div><div id="dontDiagnostic">'+lang.msgDontDiagnostic+'</div><div id="infoScene"><p id ="infoScale"></p><p id ="infoBC"></p><p id ="infoIMG"></p></div></div><div id="contProgressbar" class="col-xs-1"><div id="progressbarMobileL"><div id="scrollMobileL"></div></div><div id="progressbarMobileP"><div id="scrollMobileP"></div></div></div></div><div class="modal fade" id="setsModalMobile" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"><div class="modal-dialog modal-sm modal-setlist"><div class="modal-content"><div class="modal-header"><button type="button" class="close closeMobile" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title" id="myModalLabel">'+lang.titleSetsModal+'</h4></div><div class="modal-body"><div id="contSetlistModal" style="position: relative"><div id="setlistModal" style="height: 400px; width: 200px; display: block; overflow: scroll; -webkit-overflow-scrolling: touch;"></div><div id="waitSetModal" style="width: 200px; height: 100%; position: absolute; left: 0px; top: 0px; z-index: 30; background-color: rgba(68, 68, 68, 0.8); display: table"><div style="width: 200px; height: 50px; display: table-cell; vertical-align: middle" class="text-center"><img src="img/waiting.gif" /></div></div></div></div></div></div></div><div class="modal fade" id="reportModalMobile" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true"><div class="modal-dialog modal-lg modal-report"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title" id="myModalLabel1">'+lang.titleReportModal+'</h4></div><div class="modal-body"><div id="reportMobile-pdf"></div></div></div></div></div>'}$(".container-fluid").html(a);if(c.mobileEnvironment.isMobile()){c.changeWorkspace()}},changeWorkspace:function(){var a=this;if(a.orientation==="landscape"){$(".row").css("height","");$("#toolboxTitle").css("display","block");$("#contToolbox").removeClass("col-xs-12").addClass("col-xs-1");$("#contScene").removeClass("col-xs-12").addClass("col-xs-10");$("#contProgressbar").removeClass("col-xs-12").addClass("col-xs-1");$("#infoMedical").css("display","block");$("#infoScene").css("display","block");$("#infoMobile").removeAttr("disabled");$("#infoMobile").removeClass("btn-default").addClass("btn-warning");$("#progressbarMobileL").css("display","block");$("#progressbarMobileP").css("display","none");$("#toolboxTitle").css("display","none");$("#containerTitle").css({display:"block",width:"50px ",height:"100px"});$(".separator").css({width:"100%",height:"20px","float":"","border-left":"0px solid rgb(68, 68, 68)","border-right":"0px solid rgb(68, 68, 68)","border-top":"5px solid rgb(68, 68, 68)","border-bottom":"5px solid rgb(68, 68, 68)"});$("#playMobile").css("float","");$("#negativeMobile").css("float","");$("#rulerMobile").css("float","");$("#angleMobile").css("float","");$("#areaMobile").css("float","");$("#resetMobile").css("float","");$("#infoMobile").css("float","");$("#reportMobile").css("float","");$("#reportMobile-pdf").css("height",($(window).height()-150)+"px")}else{$(".row").css("height","50px");$("#contToolbox").removeClass("col-xs-1").addClass("col-xs-12");$("#contScene").removeClass("col-xs-10").addClass("col-xs-12");$("#contProgressbar").removeClass("col-xs-1").addClass("col-xs-12");$("#infoMedical").css("display","none");$("#infoScene").css("display","none");$("#infoMobile").attr("disabled","disabled");$("#infoMobile").removeClass("btn-warning").addClass("btn-default");$("#progressbarMobileL").css("display","none");$("#progressbarMobileP").css("display","block");$("#containerTitle").css({display:"block",width:"50px ",height:"100px"});$(".separator").css({width:"20px",height:"100%","float":"left","border-left":"5px solid rgb(68, 68, 68)","border-right":"5px solid rgb(68, 68, 68)","border-top":"0px solid rgb(68, 68, 68)","border-bottom":"0px solid rgb(68, 68, 68)"});$("#containerTitle").css({width:"100px",display:"table"});$("#toolboxTitle").css("display","table-cell");$("#playMobile").css("float","left");$("#negativeMobile").css("float","left");$("#rulerMobile").css("float","left");$("#angleMobile").css("float","left");$("#areaMobile").css("float","left");$("#resetMobile").css("float","left");$("#infoMobile").css("float","left");$("#reportMobile").css("float","left");$("#reportMobile-pdf").css("height",($(window).height()-150)+"px")}},screenTooSmall:function(){var a=this;if(a.mobileEnvironment.isMobile()){if($(window).width()<=480&&a.orientation==="portrait"){$("#toolboxTitle").css("display","none");$("#infoMobile").css({"float":"left",display:"none"});$(".separator").css({width:"5px",border:"0px solid",height:"28px"});$(".btn-size").css("font-size","10px");$("#progressbarMobileP").height(28);$("#scrollMobileP").height(28);$("#toolbox").height(28);$("#containerTitle").css({display:"block",width:"5px ",height:"28px"})}if($(window).width()<=640&&a.orientation==="landscape"){$("#toolboxTitle").css("display","none");$(".separator").css({width:"100%",border:"0px solid",height:"5px"});$(".btn-size").css("font-size","8px");$("#toolbox").css({"min-width":"20px",padding:"0px",width:"37px"});$("#contToolbox").css("padding-left","0px");$("#infoMobile").css({"float":"left",display:"none"});$("#contProgressbar").css("padding-right","0px");$("#progressbarMobileL").height($(window).height());$("#toolbox").height($(window).height())}}},toolbox:function(){var a=this;if(!a.mobileEnvironment.isMobile()){$("#report-pdf").css("height",($(window).height()-200)+"px");$("#toolbox").css({height:$(window).height()});if($(".col-xs-2").width()<=90){$("#toolboxTitle").css("display","none");$("#containerTitle").height(20)}else{$("#toolboxTitle").css("display","block");$("#containerTitle").height(20)}if($("#toolbox").width()<190){$("#setlist").css({width:"150px",display:"none"});$("#waitSet").css("display","none");$("#setlistModal").css({width:"200px",height:$("#toolbox").height()-200});$("#sets").css("display","inline")}else{$("#setlist").css({width:$("#toolbox").width(),display:"block",height:$("#toolbox").height()-($("#play").height()*3)-($("#separator").height()*4)-110});$("#sets").css("display","none");if(!a.charged){$("#waitSet").height($("#setlist").height());$("#waitSet").css("display","table")}}}else{if(a.orientation==="landscape"){$("#toolbox").css({width:"52px",height:$(window).height()})}else{$("#toolbox").css({width:"100%",height:"44px"})}$("#setlistModal").css({width:"200px",height:$(window).height()-150})}},dontDiagnostic:function(){var a=this;if(!a.mobileEnvironment.isMobile()){$("#dontDiagnostic").css("top",$(window).height()-30)}else{if(a.orientation==="landscape"){$("#dontDiagnostic").css({top:$(window).height()-30,display:"block"})}else{$("#dontDiagnostic").css("display","none")}}},sets:function(){var f=this;var g="";var c="";for(var e=0;e<f.records.length;e++){var h=f.records[e].series.url.split(",");if(h.length===1){var a=0}else{var a=parseInt((h.length/2).toFixed(0))}if(f.records[e].series.series_body_part!==null){g+='<p style="font-size: 10px; color: #fff">'+f.records[e].series.series_body_part+"</p>";c+='<p style="font-size: 10px; color: #fff">'+f.records[e].series.series_body_part+"</p>"}if(f.records[e].series.series_desc!==null){g+='<p style="font-size: 10px; color: #fff">'+f.records[e].series.series_desc+"</p>";c+='<p style="font-size: 10px; color: #fff">'+f.records[e].series.series_desc+"</p>"}g+='<p><a href="javascript: handler.loadSet('+e+')"><img id="set'+e+'" src="../wado.php?requestType=WADO'+h[a]+'&columns=150" class="setBorder"  style="margin-bottom: 5px" /></a></p>';c+='<p><a href="javascript: handler.loadSet('+e+')"><img id="setModal'+e+'" src="../wado.php?requestType=WADO'+h[a]+'&columns=150" class="setBorder" style="margin-bottom: 5px" /></a></p>'}$("#setlist").html(g);$("#setlistModal").html(c)},progressbar:function(){var a=this;if(!a.mobileEnvironment.isMobile()){if(a.resize){$("#progressbar").height($(window).height())}a.rScroll=$(window).height()/a.numImages;if(a.rScroll===0||a.rScroll<0){a.rScroll=1}var c=1;$("#scroll").height(c*a.rScroll);if(a.rScroll<10){$("#scroll").css({"border-top":"5px solid #f69322","border-bottom":"5px solid #f69322"})}if(a.numImages<10){$("#play").attr("disabled","disabled")}else{$("#play").removeAttr("disabled")}if(a.numImages===1){$("#progressbar").css("display","none")}else{$("#progressbar").css("display","block")}}else{$("#progressbarMobileL").height($(window).height());$("#progressbarMobileP").height(50);a.rScrollL=$(window).height()/a.numImages;a.rScrollP=window.screen.width/a.numImages;if(a.rScrollL===0||a.rScrollL<0){a.rScrollL=1}if(a.rScrollP===0||a.rScrollP<0){a.rScrollP=1}var c=1;$("#scrollMobileL").height(c*a.rScrollL);$("#scrollMobileP").width(c*a.rScrollP);if(a.rScrollL<10){$("#scrollMobileL").css({"border-top":"5px solid #f69322","border-bottom":"5px solid #f69322"})}if(a.rScrollP<10){$("#scrollMobileP").css({"border-left":"5px solid #f69322","border-right":"5px solid #f69322"})}if(a.numImages<10){$("#playMobile").attr("disabled","disabled")}if(a.numImages===1){$("#progressbarMobileL").css("display","none");$("#progressbarMobileP").css("display","none")}else{if(a.orientation==="landscape"){$("#progressbarMobileL").css("display","block");$("#progressbarMobileP").css("display","none")}else{$("#progressbarMobileL").css("display","none");$("#progressbarMobileP").css("display","block")}}}},configCanvas:function(){var a=this;a.canvas=document.createElement("canvas");a.canvas.setAttribute("id","myCanvas");document.getElementById("scene").appendChild(a.canvas);a.context=a.canvas.getContext("2d");a.tempCanvas=document.createElement("canvas");a.tempContext=a.tempCanvas.getContext("2d")},chargeSets:function(){var t=this;$("#waitSet").height($("#setlist").height());$("#waitSetModal").height($("#setlistModal").height());$.post("php/studies.php",{pk:study},function(data,textStatus,xhr){t.records=eval("("+data+")");$("#report-pdf").css("height",($(window).height()-200)+"px");$("#reportMobile-pdf").css("height",($(window).height()-200)+"px");if(t.records[0].series.reports!=null){$("#report-pdf").append('<iframe style="width: 100%; height: 100%" src="../wado.php?requestType=WADO'+t.records[0].series.reports+'"></iframe>');$("#reportMobile-pdf").append('<iframe style="width: 100%; height: 100%" src="../wado.php?requestType=WADO'+t.records[0].series.reports+'"></iframe>')}var d=t.records[0].series.url.split(",");for(var i=1;i<=d.length;i++){t.sources[i]=d[i-1]}var ps=t.records[0].series.pixelSpacing;if(ps===""){$("#ruler").attr("disabled","disabled");$("#area").attr("disabled","disabled");$("#rulerMobile").attr("disabled","disabled");$("#areaMobile").attr("disabled","disabled")}else{$("#ruler").removeAttr("disabled");$("#area").removeAttr("disabled");$("#rulerMobile").removeAttr("disabled");$("#areaMobile").removeAttr("disabled")}ps=ps.replace("[","");ps=ps.replace("]","");t.pixelSpacing=ps.split("\\");t.pixelSpacing[0]=parseFloat(t.pixelSpacing[0]);t.pixelSpacing[1]=parseFloat(t.pixelSpacing[1]);if(t.records[0].series.patient_name!=null){$("#infoPatientName").html(lang.patientName+": "+t.records[0].series.patient_name)}if(t.records[0].series.patient_rut!=null){$("#infoPatientId").html(lang.patientAge+": "+t.records[0].series.patient_rut)}if(t.records[0].series.patient_sex!=null){if(t.records[0].series.patient_sex==="M"){$("#infoPatientSex").html(lang.patientSex+": "+lang.patientMale)}else{$("#infoPatientSex").html(lang.patientSex+": "+lang.patientFemale)}}if(t.records[0].series.institution!=null){$("#infoInstitutionName").html(lang.institution+": "+t.records[0].series.institution)}t.sets();$(".setBorder").css("border","2px solid rgb(68, 68, 68)");$("#set0").css("border","2px solid #f69322");$("#setModal0").css("border","2px solid #f69322");t.loadImages(t.sources,function(images){if(t.mobileEnvironment.isMobile()){clearInterval(t.intervalLoad)}t.charged=true;$("#waitSet").css("display","none");$("#waitSetModal").css("display","none")})})},loadSet:function(g){var c=this;c.set=g;c.charged=true;if(c.charged){$("#waitSet").height($("#setlist").height());$("#waitSetModal").height($("#setlistModal").height());if($("#toolbox").width()>=190){$("#waitSet").css("display","table")}else{$("#waitSetModal").css("display","table")}c.charged=false;var f=c.records[g].series.url.split(",");c.sources={};for(var a=1;a<=f.length;a++){c.sources[a]=f[a-1]}var e=c.records[g].series.pixelSpacing;if(e===""){$("#ruler").attr("disabled","disabled");$("#area").attr("disabled","disabled");$("#rulerMobile").attr("disabled","disabled");$("#areaMobile").attr("disabled","disabled")}else{$("#ruler").removeAttr("disabled");$("#area").removeAttr("disabled");$("#rulerMobile").removeAttr("disabled");$("#areaMobile").removeAttr("disabled")}e=e.replace("[","");e=e.replace("]","");c.pixelSpacing=e.split("\\");c.pixelSpacing[0]=parseFloat(c.pixelSpacing[0]);c.pixelSpacing[1]=parseFloat(c.pixelSpacing[1]);if(c.records[0].series.patient_name!=null){$("#infoPatientName").html(lang.patientName+": "+c.records[0].series.patient_name)}if(c.records[0].series.patient_rut!=null){$("#infoPatientId").html(lang.patientAge+": "+c.records[0].series.patient_rut)}if(c.records[0].series.patient_sex!=null){if(c.records[0].series.patient_sex==="M"){$("#infoPatientSex").html(lang.patientSex+": "+lang.patientMale)}else{$("#infoPatientSex").html(lang.patientSex+": "+lang.patientFemale)}}if(c.records[0].series.institution!=null){$("#infoInstitutionName").html(lang.institution+": "+c.records[0].series.institution)}c.numImages=0;c.countImages=0;c.numImg=1;c.reset();c.img={};if(!c.mobileEnvironment.isMobile()){$("#scroll").css("top","0px")}else{$("#scrollMobileL").css("top","0px");$("#scrollMobileP").css("left","0px")}$(".setBorder").css("border","2px solid rgb(68, 68, 68)");$("#set"+g).css("border","2px solid #f69322");$("#setModal"+g).css("border","2px solid #f69322");c.loadImages(c.sources,function(d){if(c.mobileEnvironment.isMobile()){clearInterval(c.intervalLoad)}c.charged=true;$("#waitSet").css("display","none");$("#waitSetModal").css("display","none");if(c.numImages===c.countImages){$("#playMobile").removeAttr("disabled")}})}else{$("#waitSet").height($("#setlist").height());if($("#toolbox").width()>=190){$("#waitSet").css("display","table")}else{$("#waitSetModal").css("display","table")}}},loadImages:function(c,m){var n=this;$(".modal").modal("hide");$(window).bind("touchmove",function(d){d.preventDefault()});var l={};var h=0;var g=1;var e=false;for(var f in c){n.numImages++}n.progressbar();n.screenTooSmall();var k=1;if(!n.mobileEnvironment.isMobile()){for(var a=1;a<=n.numImages;a++){l[a]=new Image();n.img[a]=l[a];l[a].onload=(function(d){return function(){if(d===1){n.respScene();n.drawScene(1);if(!n.mobileEnvironment.isMobile()){$("#progressbar").height(k*n.rScroll);$("#scroll").css("display","block")}else{$("#progressbarMobileL").height(k*n.rScrollL);$("#scrollMobileL").css("display","block");$("#progressbarMobileP").width(k*n.rScrollP);$("#scrollMobileP").css("display","block")}}else{if(!n.mobileEnvironment.isMobile()){$("#progressbar").height(k*n.rScroll)}else{$("#progressbarMobileL").height(k*n.rScrollL);$("#progressbarMobileP").width(k*n.rScrollP)}}k++;n.countImages++;$("#infoIMG").html(lang.NumImages+": "+n.numImg+" "+lang.ofImages+" "+n.countImages);if(++h>=n.numImages){m(l)}}})(a);l[a].src="../wado.php?requestType=WADO"+c[a]}}else{var a=1;n.intervalLoad=setInterval(function(){l[a]=new Image();n.img[a]=l[a];l[a].onload=(function(d){return function(){if(d===1||d===2){n.respScene();n.drawScene(1);if(!n.mobileEnvironment.isMobile()){$("#progressbar").height(k*n.rScroll);$("#scroll").css("display","block")}else{$("#progressbarMobileL").height(k*n.rScrollL);$("#scrollMobileL").css("display","block");$("#progressbarMobileP").width(k*n.rScrollP);$("#scrollMobileP").css("display","block")}}else{if(!n.mobileEnvironment.isMobile()){$("#progressbar").height(k*n.rScroll)}else{$("#progressbarMobileL").height(k*n.rScrollL);$("#progressbarMobileP").width(k*n.rScrollP)}}k++;n.countImages++;$("#infoIMG").html(lang.NumImages+": "+n.numImg+" "+lang.ofImages+" "+n.countImages);if(++h>=n.numImages){m(l)}}})(a);l[a].src="../wado.php?requestType=WADO"+c[a];a++},75)}},respScene:function(){var c=this;var a=c.img[c.numImg].width/c.img[c.numImg].height;if(!c.mobileEnvironment.isMobile()){c.canvasSize.w=$(".col-xs-9").width();c.canvasSize.h=$(window).height()}else{if(c.orientation==="landscape"){c.canvasSize.w=$(".col-xs-10").width();c.canvasSize.h=$(window).height()}else{c.canvasSize.w=$(".col-xs-12").width();c.canvasSize.h=$(window).height()}}if(c.canvasSize.w/c.canvasSize.h>a){c.imgSize.h=c.canvasSize.h;c.imgSize.w=c.imgSize.h*a}else{c.imgSize.w=c.canvasSize.w;c.imgSize.h=c.imgSize.w/a}if(c.resize){c.respScale=c.imgSize.w/c.img[c.numImg].width;c.infoScale=(c.respScale*c.scale);$("#infoScale").html(lang.scale+": "+c.infoScale.toFixed(2));c.ctxRatioW=1;c.ctxRatioH=1;if(!c.mobileEnvironment.isMobile()){c.canvas.width=$(".col-xs-9").width()}else{if(c.orientation==="landscape"){c.canvas.width=$(".col-xs-10").width()}else{c.canvas.width=$(".col-xs-12").width()}}c.canvas.height=$(window).height();if(!c.mobileEnvironment.isMobile()&&c.scale!=1){zoom.lastTransformImage()}c.origin.x=c.origin.x/c.ctxRatioW;c.origin.y=c.origin.y/c.ctxRatioH;c.context.scale(c.ctxRatioW,c.ctxRatioH)}else{if(!c.mobileEnvironment.isMobile()){c.respScale=c.imgSize.w/c.img[c.numImg].width;c.infoScale=c.respScale;$("#infoScale").html(lang.scale+": "+c.infoScale.toFixed(2));c.canvas.width=$(".col-xs-9").width();c.canvas.height=$(window).height()}else{c.respScale=c.imgSize.w/c.img[c.numImg].width;c.infoScale=(c.respScale*c.mscale);$("#infoScale").html(lang.scale+": "+c.infoScale.toFixed(2));if(c.orientation==="landscape"){c.canvas.width=$(".col-xs-10").width();c.canvas.height=c.imgSize.h}else{c.canvas.width=$(".col-xs-12").width();c.canvas.height=c.imgSize.h}}}c.imgLastSize.w=c.imgSize.w;c.imgLastSize.h=c.imgSize.h;if(!c.mobileEnvironment.isMobile()){$("#myCanvas").width($(".col-xs-9").width());$("#myCanvas").height($(window).height());$("#scene").width($(".col-xs-9").width());$("#scene").height($(window).height())}else{if(c.orientation==="landscape"){$("#myCanvas").width($(".col-xs-10").width());$("#myCanvas").height(c.imgSize.h);$("#scene").width($(".col-xs-10").width());$("#scene").height(c.imgSize.h)}else{$("#myCanvas").width($(".col-xs-12").width());$("#myCanvas").height(c.imgSize.h);$("#scene").width($(".col-xs-12").width());$("#scene").height(c.imgSize.h)}}if(c.resize){c.imgStartPos.x=(($("#scene").width()-c.imgSize.w)/2)/c.ctxRatioW}else{c.imgStartPos.x=($("#scene").width()-c.imgSize.w)/2}c.drawScene(c.numImg)},drawScene:function(c){var a=this;$("#infoIMG").html(lang.NumImages+": "+a.numImg+" "+lang.ofImages+" "+a.countImages);a.context.save();a.context.setTransform(1,0,0,1,0,0);a.context.clearRect(0,0,a.canvas.width,a.canvas.height);a.context.restore();if(!handler.mobileEnvironment.isMobile()){a.context.drawImage(a.img[c],a.imgStartPos.x,a.imgStartPos.y,a.imgSize.w,a.imgSize.h);a.tempCanvas.width=a.canvas.width;a.tempCanvas.height=a.canvas.height;a.tempContext.drawImage(a.canvas,0,0);filter.filtered()}else{if(handler.mobileEnvironment.isIOS()){a.drawSceneMobile(a.imgStartPos.x,a.imgStartPos.y,a.imgSize.w,a.imgSize.h)}else{a.context.drawImage(a.img[c],a.imgStartPos.x,a.imgStartPos.y,a.imgSize.w,a.imgSize.h)}}},zoomEffect:function(){$("#myCanvas").on("mousemove",zoom.on)},dragEffect:function(){$("#myCanvas").on("mousemove",drag.on)},filter:function(){$("#myCanvas").on("mousemove",filter.on)},negative:function(){var a=this;if(!a.mobileEnvironment.isMobile()){a.canvas.style.backgroundColor="#fff";$(".col-xs-9").css("background-color","#fff");handler.isNegative=true;filter.negative()}else{a.mn=1;if(a.orientation==="landscape"){$(".col-xs-10").css("background-color","#fff")}else{$("#contScene").css("background-color","#fff")}$("#myCanvas").css("-webkit-filter","contrast("+a.mc+") brightness("+a.mb+") invert("+a.mn+")")}},rmNegative:function(){var a=this;if(!a.mobileEnvironment.isMobile()){a.canvas.style.backgroundColor="#000";$(".col-xs-9").css("background-color","#000");handler.isNegative=false;filter.negative()}else{a.mn=0;if(a.orientation==="landscape"){$(".col-xs-10").css("background-color","#000")}else{$("#contScene").css("background-color","#000")}$("#myCanvas").css("-webkit-filter","contrast("+a.mc+") brightness("+a.mb+") invert("+a.mn+")")}},magnifyingGlass:function(){zoom.magnifyingGlass()},rmMagnifyingGlass:function(){$("#scene").unbind("mousemove");var a=document.getElementById("magnifyingGlass");a.parentNode.removeChild(a)},playset:function(a){animation.on(a)},ruler:function(){measuring.ruler()},rmRuler:function(){if(!handler.mobileEnvironment.isMobile()){var a=document.getElementById("mRuler");a.parentNode.removeChild(a);$("#scene h5").remove()}else{var a=document.getElementById("mRulerMobile");a.parentNode.removeChild(a);$("#scene h5").remove()}},angle:function(){measuring.angle()},rmAngle:function(){if(!handler.mobileEnvironment.isMobile()){var a=document.getElementById("mAngle");a.parentNode.removeChild(a);$("#scene h5").remove()}else{var a=document.getElementById("mAngleMobile");a.parentNode.removeChild(a);$("#scene h5").remove()}},area:function(){measuring.area()},rmArea:function(){if(!handler.mobileEnvironment.isMobile()){var a=document.getElementById("mArea");a.parentNode.removeChild(a);$("#scene h5").remove()}else{var a=document.getElementById("mAreaMobile");a.parentNode.removeChild(a);$("#scene h5").remove()}},reset:function(){var a=this;if(!a.mobileEnvironment.isMobile()){if($("#negative").hasClass("btn-warning")){$("#negative").removeClass("btn-warning").addClass("btn-default");a.rmNegative()}if($("#ruler").hasClass("btn-warning")){$("#ruler").removeClass("btn-warning").addClass("btn-default");a.rmRuler()}if($("#angle").hasClass("btn-warning")){$("#angle").removeClass("btn-warning").addClass("btn-default");a.rmAngle()}if($("#area").hasClass("btn-warning")){$("#area").removeClass("btn-warning").addClass("btn-default");a.rmArea()}if($("#magGlass").hasClass("btn-warning")){$("#magGlass").removeClass("btn-warning").addClass("btn-default");a.rmMagnifyingGlass()}if($("#info").hasClass("btn-default")){$("#info").removeClass("btn-default").addClass("btn-warning");a.info()}if($("#report").hasClass("btn-warning")){$("#report").removeClass("btn-warning").addClass("btn-default");a.rmReport()}if($("#play").hasClass("btn-warning")){$("#play").removeClass("btn-warning").addClass("btn-default");$("#play").children().removeClass("glyphicon-pause").addClass("glyphicon-play");a.playset()}a.tool=1;a.ba=1;a.b=1;a.c=1;$("#infoBC").html(lang.brightness+": "+a.b.toFixed(2)+" | "+lang.contrast+": "+a.c.toFixed(2));a.scale=1;a.origin.x=0;a.origin.y=0;a.canvas.width=a.canvas.width;a.resize=false;a.respScene()}else{if($("#negativeMobile").hasClass("btn-warning")){$("#negativeMobile").removeClass("btn-warning").addClass("btn-default");a.rmNegative()}if($("#rulerMobile").hasClass("btn-warning")){$("#rulerMobile").removeClass("btn-warning").addClass("btn-default");a.rmRuler()}if($("#angleMobile").hasClass("btn-warning")){$("#angleMobile").removeClass("btn-warning").addClass("btn-default");a.rmAngle()}if($("#areaMobile").hasClass("btn-warning")){$("#areaMobile").removeClass("btn-warning").addClass("btn-default");a.rmArea()}if($("#infoMobile").hasClass("btn-default")){$("#infoMobile").removeClass("btn-default").addClass("btn-warning");if(a.orientation==="landscape"){a.info()}}if($("#reportMobile").hasClass("btn-warning")){$("#reportMobile").removeClass("btn-warning").addClass("btn-default");a.rmReport()}if($("#playMobile").hasClass("btn-warning")){$("#playMobile").removeClass("btn-warning").addClass("btn-default");$("#playMobile").children().removeClass("glyphicon-pause").addClass("glyphicon-play");a.playset()}a.tool=1;a.mb=1;a.mc=1;a.mn=0;a.deltaX=1;a.deltaY=1;$("#myCanvas").css("-webkit-filter","contrast("+a.mc+") brightness("+a.mb+") invert("+a.mn+")");$("#infoBC").html(lang.brightness+": "+a.mb.toFixed(2)+" | "+lang.contrast+": "+a.mc.toFixed(2));a.mscale=1;a.posStartTwoFingers={x:0,y:0};a.posMoveTwoFingers={x:0,y:0};a.posDiffTwoFingers={x:0,y:0};a.posScaleTwoFingers={x:0,y:0};a.lastDrag={x:0,y:0};a.posMoveLast={x:0,y:0};a.posOrigin={x:0,y:0};a.posTranslate={x:0,y:0};a.posMoveFix={x:0,y:0};a.mlastScale=1;a.morigin=a.posOrigin.x+"px "+a.posOrigin.y+"px";a.mtranslate=a.posTranslate.x+"px, "+a.posTranslate.y+"px";$("#myCanvas").css("-webkit-transform","scale("+a.mscale+") translate("+a.mtranslate+")");$("#myCanvas").css("-webkit-transform-origin",a.morigin);$("#myCanvas").css({left:a.posDiffTwoFingers.x,top:a.posDiffTwoFingers.y})}},report:function(){},rmReport:function(){},info:function(){$("#infoMedical").css("display","block");$("#infoScene").css("display","block")},rmInfo:function(){$("#infoMedical").css("display","none");$("#infoScene").css("display","none")},infoScene:function(){var a=this;if(!a.mobileEnvironment.isMobile()){$("#infoScene").css({left:$(".col-xs-9").width()+30-$("#infoScene").width()-20});$("#infoBC").html(lang.brightness+": "+a.b.toFixed(2)+" | "+lang.contrast+": "+a.c.toFixed(2))}else{$("#infoScene").css({left:$(".col-xs-10").width()+30-$("#infoScene").width()-20});$("#infoBC").html(lang.brightness+": "+a.mb.toFixed(2)+" | "+lang.contrast+": "+a.mc.toFixed(2))}},infoTooSmall:function(){var a=this;if(!a.mobileEnvironment.isMobile()){if(($("#infoMedical").width()+$("#infoScene").width()+40)>=$(".col-xs-9").width()){a.rmInfo();$("#info").attr("disabled","disabled")}else{a.info();$("#info").removeAttr("disabled")}}else{if(($("#infoMedical").width()+$("#infoScene").width()+40)>=$(".col-xs-10").width()){a.rmInfo();$("#info").attr("disabled","disabled")}else{a.info();$("#info").removeAttr("disabled")}}},resizeMeasuring:function(){var a=this;if($("#ruler").hasClass("btn-warning")){$("#ruler").removeClass("btn-warning").addClass("btn-default");a.rmRuler()}if($("#angle").hasClass("btn-warning")){$("#angle").removeClass("btn-warning").addClass("btn-default");a.rmAngle()}if($("#area").hasClass("btn-warning")){$("#area").removeClass("btn-warning").addClass("btn-default");a.rmArea()}a.tool=1},resizeMeasuringMobile:function(){var a=this;if($("#rulerMobile").hasClass("btn-warning")){$("#rulerMobile").removeClass("btn-warning").addClass("btn-default");a.rmRuler()}if($("#angleMobile").hasClass("btn-warning")){$("#angleMobile").removeClass("btn-warning").addClass("btn-default");a.rmAngle()}if($("#areaMobile").hasClass("btn-warning")){$("#areaMobile").removeClass("btn-warning").addClass("btn-default");a.rmArea()}a.tool=1},removeBeforeTool:function(c){var a=this;if(!handler.mobileEnvironment.isMobile()){switch(handler.tool){case 1:break;case 2:$("#magGlass").removeClass("btn-warning").addClass("btn-default");a.rmMagnifyingGlass();break;case 3:break;case 4:$("#play").removeClass("btn-warning").addClass("btn-default");$("#play").children().removeClass("glyphicon-pause").addClass("glyphicon-play");a.playset(c);break;case 5:$("#ruler").removeClass("btn-warning").addClass("btn-default");a.rmRuler();break;case 6:$("#angle").removeClass("btn-warning").addClass("btn-default");a.rmAngle();break;case 7:$("#area").removeClass("btn-warning").addClass("btn-default");a.rmArea();break;case 8:break;case 9:break;case 10:break}}else{switch(handler.tool){case 1:break;case 2:break;case 3:break;case 4:$("#playMobile").removeClass("btn-warning").addClass("btn-default");$("#playMobile").children().removeClass("glyphicon-pause").addClass("glyphicon-play");a.playset(c);break;case 5:$("#rulerMobile").removeClass("btn-warning").addClass("btn-default");a.rmRuler();break;case 6:$("#angleMobile").removeClass("btn-warning").addClass("btn-default");a.rmAngle();break;case 7:$("#areaMobile").removeClass("btn-warning").addClass("btn-default");a.rmArea();break;case 8:break;case 9:break}}},progressbarScroll:function(){var a=this;if(!a.mobileEnvironment.isMobile()){$("#progressbar").on("mousemove",function(d){if($("#ruler").hasClass("btn-warning")){$("#ruler").removeClass("btn-warning").addClass("btn-default");handler.rmRuler();handler.tool=1}if($("#angle").hasClass("btn-warning")){$("#angle").removeClass("btn-warning").addClass("btn-default");handler.rmAngle();handler.tool=1}if($("#area").hasClass("btn-warning")){$("#area").removeClass("btn-warning").addClass("btn-default");handler.rmArea();handler.tool=1}var e=d.clientY;var c=(e/a.rScroll).toFixed(0);var f=(e/a.rScroll).toFixed(2);if(c<f){c++}if(c>a.numImages){c=a.numImages}handler.numImg=c;if(a.numImg>a.numImages){a.numImg=a.numImages}else{if(a.numImg<1){a.numImg=1}}if((a.countImages*a.rScroll)>((c-1)*a.rScroll)){$("#scroll").css("top",(c-1)*a.rScroll);a.drawScene(a.numImg)}})}else{$("#progressbarMobileL").bind("touchmove",function(d){var e=d.originalEvent.touches[0].pageY-$(this).offset().top;var c=(e/a.rScrollL).toFixed(0);var f=(e/a.rScrollL).toFixed(2);if(c<f){c++}if(c>a.numImages){c=a.numImages}handler.numImg=c;if(a.numImg>a.numImages){a.numImg=a.numImages}else{if(a.numImg<1){a.numImg=1}}if((a.countImages*a.rScrollL)>((c-1)*a.rScrollL)){$("#scrollMobileL").css("top",(c-1)*a.rScrollL);$("#scrollMobileP").css("left",(c-1)*a.rScrollP);a.drawScene(a.numImg)}});$("#progressbarMobileP").bind("touchmove",function(d){var e=d.originalEvent.touches[0].pageX-$(this).offset().left;var c=(e/a.rScrollP).toFixed(0);var f=(e/a.rScrollP).toFixed(2);if(c<f){c++}if(c>a.numImages){c=a.numImages}handler.numImg=c;if(a.numImg>a.numImages){a.numImg=a.numImages}else{if(a.numImg<1){a.numImg=1}}if((a.countImages*a.rScrollP)>((c-1)*a.rScrollP)){$("#scrollMobileL").css("top",(c-1)*a.rScrollL);$("#scrollMobileP").css("left",(c-1)*a.rScrollP);a.drawScene(a.numImg)}})}},detectBrowser:{objappVersion:navigator.appVersion,objAgent:navigator.userAgent,isFirefox:function(){b=this;if(b.objAgent.indexOf("Firefox")!=-1){return true}else{return false}},isMSIE:function(){b=this;if(b.objAgent.indexOf("MSIE")!=-1){return true}else{return false}}},detectVerticalSquash:function(){var j=this;var g=document.createElement("canvas"),k=g.getContext("2d");g.width=1;g.height=j.img[1].height;k.drawImage(j.img[1],0,0);var d=k.getImageData(0,0,1,j.img[1].height).data,h=0,e=j.img[1].height,i=j.img[1].height;while(i>h){var a=d[(i-1)*4+3];if(a===0){e=i}else{h=i}i=(e+h)>>1}var f=(i/j.img[1].height);return(f===0)?1:f},drawSceneMobile:function(g,f,a,e){var d=this;var c=handler.detectVerticalSquash();d.context.drawImage(d.img[d.numImg],g,f,a,e/c)},mobileEnvironment:{isMobile:function(){if(handler.mobileEnvironment.isIOS()||handler.mobileEnvironment.isAndroid()){return true}else{return false}},isAndroid:function(){if(navigator.userAgent.match(/Android/i)=="Android"){return true}else{return false}},isIOS:function(){if((navigator.userAgent.match(/iPhone|iPad|iPod/i)=="iPhone")||(navigator.userAgent.match(/iPhone|iPad|iPod/i)=="iPad")||(navigator.userAgent.match(/iPhone|iPad|iPod/i)=="iPod")){return true}else{return false}}}};